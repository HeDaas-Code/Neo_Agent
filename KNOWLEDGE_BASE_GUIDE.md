# 知识库系统使用指南

## 概述

知识库系统是智能对话代理的核心功能之一，它能够从对话中自动提取、存储和管理用户信息和知识点。

## 工作原理

### 自动提取机制

```
对话进行 → 每5轮触发 → LLM分析 → 提取知识 → 结构化存储 → 更新GUI
```

### 触发条件

- **频率**：每进行5轮对话（10条消息）
- **时机**：用户消息发送后
- **范围**：分析最近5轮对话内容

## 知识结构

每条知识包含以下字段：

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| uuid | String | 唯一标识符 | "a1b2c3d4-..." |
| title | String | 知识标题（简短） | "喜欢历史" |
| content | String | 知识详细内容 | "用户表示特别喜欢历史..." |
| type | String | 知识类型 | "偏好" |
| source | String | 来源描述 | "对话记录" |
| created_at | ISO8601 | 创建时间 | "2025-11-14T21:00:00" |
| updated_at | ISO8601 | 更新时间 | "2025-11-14T21:00:00" |
| source_time_range | Object | 来源时间范围 | {start: "...", end: "..."} |
| tags | Array | 标签列表 | ["偏好", "历史"] |

## 知识类型说明

### 1. 个人信息
用户的基本资料、身份、职业等客观信息。

**示例**：
- "用户是一名软件工程师"
- "用户住在北京"
- "用户26岁"

### 2. 偏好
用户的喜好、兴趣、习惯等主观倾向。

**示例**：
- "用户喜欢阅读科幻小说"
- "用户偏好喝咖啡"
- "用户喜欢早上运动"

### 3. 事实
客观的知识性信息、学到的内容。

**示例**：
- "Python是一种编程语言"
- "长城是中国的著名景点"
- "光速是每秒30万公里"

### 4. 经历
用户分享的经历、故事、回忆。

**示例**：
- "用户去年去过日本旅游"
- "用户在大学期间学过历史"
- "用户曾经参加过马拉松"

### 5. 观点
用户表达的看法、意见、态度。

**示例**：
- "用户认为AI会改变世界"
- "用户觉得历史很有趣"
- "用户不喜欢加班文化"

### 6. 其他
不属于以上分类的知识。

## 使用方法

### 在GUI中查看知识

1. 启动增强版GUI：`python gui_enhanced.py`
2. 切换到"📚 知识库"标签页
3. 查看按类型分组的知识列表

### 搜索知识

1. 在知识库标签页的搜索框中输入关键词
2. 点击🔍按钮
3. 查看搜索结果

**搜索范围**：
- 知识标题
- 知识内容

### 筛选知识

1. 在"类型"下拉框中选择知识类型
2. 自动筛选该类型的所有知识
3. 选择"全部"可查看所有知识

### 刷新知识库

点击"刷新"按钮，重新加载知识库数据。

## 编程接口

### 获取所有知识

```python
from chat_agent import ChatAgent

agent = ChatAgent()
knowledge_list = agent.get_all_knowledge()

for k in knowledge_list:
    print(f"[{k['type']}] {k['title']}")
    print(f"  {k['content']}")
```

### 搜索知识

```python
# 关键词搜索
results = agent.search_knowledge(keyword="历史")

# 类型筛选
results = agent.search_knowledge(knowledge_type="偏好")

# 组合搜索
results = agent.search_knowledge(keyword="历史", knowledge_type="偏好")
```

### 访问知识库对象

```python
kb = agent.get_knowledge_base()

# 获取统计信息
stats = kb.get_statistics()
print(f"总知识数: {stats['total_knowledge']}")
print(f"类型分布: {stats['type_distribution']}")

# 根据UUID获取知识
knowledge = kb.get_knowledge_by_uuid("uuid-here")
```

## 文件格式

### knowledge_base.json

```json
{
  "knowledge_items": [
    {
      "uuid": "6927c162-a9fb-4468-bda1-eb0fd6158959",
      "title": "喜欢历史",
      "content": "用户表示特别喜欢中国历史，尤其是唐宋时期",
      "type": "偏好",
      "source": "对话记录",
      "created_at": "2025-11-14T21:00:00.000000",
      "updated_at": "2025-11-14T21:00:00.000000",
      "source_time_range": {
        "start": "2025-11-14T20:55:00.183174",
        "end": "2025-11-14T21:00:00.755397"
      },
      "tags": ["偏好"]
    }
  ],
  "metadata": {
    "created_at": "2025-11-14T20:00:00.000000",
    "total_knowledge": 1,
    "last_extraction": "2025-11-14T21:00:00.000000"
  },
  "last_updated": "2025-11-14T21:00:00.000000"
}
```

## 知识提取示例

### 示例对话

```
[第1轮]
用户: 你好，我叫张三
小可: 你好呀张三！

[第2轮]
用户: 我是一名程序员
小可: 哇，程序员好厉害！

[第3轮]
用户: 我特别喜欢Python
小可: Python确实很棒呢！

[第4轮]
用户: 我最近在学机器学习
小可: 机器学习很有前景！

[第5轮]
用户: 我觉得AI会改变世界
小可: 我也这么认为！

[系统提示] 📚 已达到 5 轮对话，开始提取知识...
[系统提示] ✓ 提取到 5 条知识
```

### 提取的知识

```json
[
  {
    "title": "姓名-张三",
    "content": "用户的姓名是张三",
    "type": "个人信息"
  },
  {
    "title": "职业-程序员",
    "content": "用户是一名程序员",
    "type": "个人信息"
  },
  {
    "title": "喜欢Python",
    "content": "用户特别喜欢Python编程语言",
    "type": "偏好"
  },
  {
    "title": "学习机器学习",
    "content": "用户最近在学习机器学习",
    "type": "经历"
  },
  {
    "title": "AI观点",
    "content": "用户认为AI会改变世界",
    "type": "观点"
  }
]
```

## 最佳实践

### 提高知识提取质量

1. **明确表达**：清晰地表达你的信息
   - ✅ "我是一名软件工程师，有5年经验"
   - ❌ "嗯...我做这行挺久了"

2. **提供上下文**：给出足够的背景信息
   - ✅ "我在大学时学过历史，特别喜欢唐朝"
   - ❌ "喜欢"

3. **分享细节**：具体的信息更容易被提取
   - ✅ "我每天早上7点跑步，已经坚持了2年"
   - ❌ "我有运动习惯"

### 知识管理建议

1. **定期查看**：每隔几轮对话查看知识库，了解系统记住了什么
2. **搜索验证**：使用搜索功能验证重要信息是否被正确提取
3. **类型筛选**：按类型查看，确保信息分类合理
4. **备份数据**：定期备份`knowledge_base.json`文件

## 故障排查

### 问题1：没有提取到知识

**可能原因**：
- 对话轮数未达到5轮
- 对话中没有明确的信息
- API调用失败

**解决方法**：
- 检查对话轮数
- 在对话中明确表达信息
- 查看控制台的错误日志

### 问题2：知识提取不准确

**可能原因**：
- LLM模型理解偏差
- 对话内容模糊
- 上下文不足

**解决方法**：
- 使用更强大的模型
- 提供更清晰的信息
- 在5轮对话中保持话题连贯

### 问题3：知识库文件损坏

**可能原因**：
- 手动编辑JSON格式错误
- 程序异常中断

**解决方法**：
- 使用JSON验证工具检查格式
- 从备份恢复
- 删除文件让系统重新创建

## 高级功能（未来版本）

- [ ] 知识更新和编辑
- [ ] 知识合并（去重）
- [ ] 知识导出（CSV, Excel）
- [ ] 知识可视化（思维导图）
- [ ] 知识关联分析
- [ ] 自定义提取规则
- [ ] 多语言支持

## 技术细节

### 提取流程

```python
def _extract_and_save_knowledge(self):
    # 1. 获取最近5轮对话
    recent_messages = self._get_recent_rounds(5)
    
    # 2. 调用LLM提取知识
    knowledge_list = self.knowledge_base.extract_knowledge(recent_messages)
    
    # 3. 为每条知识生成UUID
    for knowledge_data in knowledge_list:
        knowledge_uuid = self.knowledge_base.add_knowledge(
            knowledge_data, 
            recent_messages
        )
    
    # 4. 保存到文件
    self.knowledge_base.save_knowledge()
```

### LLM提示词

系统使用精心设计的提示词来指导LLM提取知识：

```
请从以下对话中提取用户提到的关键信息和知识点。

要求：
1. 识别用户分享的事实性信息、个人信息、偏好、经历等
2. 每个知识点包含：标题、内容、类型
3. 只提取明确的、有价值的信息
4. 以JSON格式返回

[对话内容]
...
```

## 总结

知识库系统让AI能够：
- 📝 记住用户的信息
- 🎯 理解用户的偏好
- 💡 积累对话中的知识
- 🔍 快速检索历史信息
- 📊 结构化管理知识

通过持续的对话，系统会不断丰富知识库，从而提供更个性化、更智能的对话体验。

