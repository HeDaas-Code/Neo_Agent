# 智能对话代理系统 v3.0

基于LangChain和Python开发的智能对话代理系统，支持角色扮演、三层记忆管理（短期+长期+知识库）和可视化调试。

## 功能特性

### 🎭 角色扮演
- 从.env文件读取角色设定
- 支持自定义角色性格、背景、爱好等
- 默认角色：学生小可（活泼开朗，喜欢历史）

### 🧠 三层记忆系统
- **短期记忆**：保存最近20轮对话的详细内容（memory_data.json）
- **长期记忆**：超过20轮的对话自动归档为概括性记忆（longmemory_data.json）
- **知识库**：每5轮对话自动提取知识点（knowledge_base.json）
- **智能概括**：使用LLM自动生成主题概括和知识提取
- **UUID标识**：每个长期记忆和知识都有唯一���识

### 📚 知识库系统（NEW!）
- **自动提取**：每5轮对话自动分析并提取用户信息
- **结构化存储**：每条知识包含标题、内容、类型、来源、标签等
- **知识分类**：自动分类为个人信息、偏好、事实、经历、观点等
- **搜索功能**：支持关键词搜索和类型筛选
- **UUID追踪**：每条知识都有唯一UUID便于管理
- **时间追溯**：记录知识来源的时间范围

### 📊 可视化界面
- **主题时间线**：图形化展示聊天主题的变化轨迹
- **知识库面板**：以结构化方式展示所有知识点
- **点击交互**：点击时间线节点查看详细概括信息
- **实时更新**：记忆归档和知识提取时自动更新界面
- **多标签页**：系统信息、短期记忆、长期记忆、知识库、控制面板

## 项目结构

```
LC_Project/
├── .env                        # 配置文件（API密钥、角色设定等）
├── requirements.txt            # Python依赖包
├── chat_agent.py              # 聊天代理核心模块
├── long_term_memory.py        # 长效记忆管理模块
├── knowledge_base.py          # 知识库管理模块（NEW!）
├── gui_debug.py               # 基础GUI界面
├── gui_enhanced.py            # 增强版GUI界面（推荐使用）
├── start_gui.py               # 快速启动脚本
├── test_system.py             # 系统测试脚本
├── memory_data.json           # 短期记忆数据（自动生成）
├── longmemory_data.json       # 长期记忆数据（自动生成）
└── knowledge_base.json        # 知识库数据（自动生成，NEW!）
```

## 安装步骤

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置API密钥

编辑`.env`文件，设置您的SiliconFlow API密钥：

```env
SILICONFLOW_API_KEY=your_api_key_here
```

### 3. 自定义角色（可选）

在`.env`文件中修改角色设定：

```env
CHARACTER_NAME=小可
CHARACTER_GENDER=女
CHARACTER_ROLE=学生
CHARACTER_AGE=18
CHARACTER_PERSONALITY=活泼开朗
CHARACTER_HOBBY=文科，尤其对历史充满热情
CHARACTER_BACKGROUND=我是一名高中生，叫小可...
```

## 使用方法

### 启动增强版GUI（推荐）

**方式1：使用启动脚本**
```bash
python start_gui.py
```

**方式2：直接启动**
```bash
python gui_enhanced.py
```

### 启动基础GUI

```bash
python gui_debug.py
```

### 命令行模式

```bash
python chat_agent.py
```

## 记忆系统详解

### 短期记忆（memory_data.json）

```json
{
  "messages": [
    {
      "role": "user",
      "content": "你好",
      "timestamp": "2025-11-14T20:44:10.942693"
    },
    {
      "role": "assistant",
      "content": "你好呀！我是小可...",
      "timestamp": "2025-11-14T20:44:11.855484"
    }
  ],
  "metadata": {
    "created_at": "2025-11-14T20:43:56.635027",
    "total_conversations": 3
  }
}
```

**特点**：
- 保存最近20轮对话（40条消息）
- 包含完整的对话内容和时间戳
- 超过20轮自动触发归档

### 长期记忆（longmemory_data.json）

```json
{
  "summaries": [
    {
      "uuid": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "created_at": "2025-11-14T10:00:00.000000",
      "ended_at": "2025-11-14T10:30:00.000000",
      "rounds": 20,
      "message_count": 40,
      "summary": "讨论了中国古代历史，重点聊了唐朝的文化和科举制度..."
    }
  ],
  "metadata": {
    "created_at": "2025-11-14T10:00:00.000000",
    "total_summaries": 1
  }
}
```

**特点**：
- 每20轮对话生成一个概括
- 使用UUID唯一标识
- 记录时间范围和对话轮数
- LLM自动生成主题概括

### 记忆归档流程

1. 用户发送消息，对话轮数+1
2. **每5轮触发知识提取**：
   - 取出最近5轮对话
   - 调用LLM提取用户信息和知识点
   - 为每条知识生成UUID和元数据
   - 保存到knowledge_base.json
3. **每20轮触发主题归档**：
   - 取出最早的20轮对话
   - 调用LLM生成主题概括
   - 创建长期记忆条目（含UUID和时间戳）
   - 保存到longmemory_data.json
   - 从短期记忆中移除已归档的对话
4. 更新GUI显示（时间线、知识库）

## 知识库系统详解

### 知识结构（knowledge_base.json）

```json
{
  "knowledge_items": [
    {
      "uuid": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "title": "喜欢历史",
      "content": "用户表示特别喜欢历史，尤其是中国古代史",
      "type": "偏好",
      "source": "对话记录",
      "created_at": "2025-11-14T21:00:00.000000",
      "updated_at": "2025-11-14T21:00:00.000000",
      "source_time_range": {
        "start": "2025-11-14T20:55:00.000000",
        "end": "2025-11-14T21:00:00.000000"
      },
      "tags": ["偏好", "历史"]
    }
  ],
  "metadata": {
    "created_at": "2025-11-14T20:00:00.000000",
    "total_knowledge": 1,
    "last_extraction": "2025-11-14T21:00:00.000000"
  }
}
```

### 知识类型

系统会自动将知识分类为以下类型：

- **个人信息**：用户的基本信息、身份、职业等
- **偏好**：用户的喜好、兴趣、习惯等
- **事实**：客观的事实性信息
- **经历**：用户的经历、故事、回忆等
- **观点**：用户的看法、意见、态度等
- **其他**：不属于以上类型的知识

### 知识提取原理

每5轮对话后，系统会：
1. 收集最近5轮的对话内容
2. 使用LLM分析对话，识别：
   - 用户明确提到的信息
   - 用户的偏好和兴趣
   - 用户分享的经历和故事
   - 用户表达的观点和态度
3. 将提取的知识结构化存储
4. 自动生成标签便于分类和搜索

### 记忆归档流程（更新）

## GUI功能说明

### 布局优化
- **输入框固定底部**：输入区域始终固定在界面底部，不会被其他组件挤压
- **固定高度组件**：标题栏、角色信息、记忆状态栏、输入框都使用固定高度
- **自适应聊天区**：聊天显示区域自动填充剩余空间，最大化利用界面
- **时间线紧凑显示**：主题时间线固定130px高度，不占用过多空间
- **窗口最小尺寸**：设置最小窗口尺寸为1000x700，防止布局混乱

### 主题时间线
- **节点显示**：每个节点代表一个归档的主题
- **颜色编码**：不同颜色区分不同主题
- **箭头连接**：显示主题变化的时间顺序
- **悬停效果**：鼠标悬停时改变光标
- **点击查看**：点击节点显示详细信息

### 控制面板
- **🔄 刷新所有信息**：更新所有显示区域
- **📈 更新主题时间线**：重绘时间线图
- **🗑️ 清空所有记忆**：删除短期和长期记忆
- **♻️ 重新加载代理**：重新读取配置文件

### 标签页
- **系统信息**：显示角色信息、配置参数、文件路径
- **短期记忆**：查看最近20轮的详细对话
- **长期记忆**：查看所有归档的主题概括
- **知识库**：浏览、搜索和管理知识点（NEW!）
  - 按类型分组显示
  - 关键词搜索
  - 类型筛选
  - 显示每条知识的UUID、时间、标签
- **控制面板**：操作按钮和系统设置

## 快捷键

- **Enter**：发送消息
- **Ctrl+Enter**：在输入框中换行

## 注意事项

1. **API密钥**：必须配置有效的SiliconFlow API密钥
2. **网络连接**：需要稳定的网络连接调用API
3. **记忆文件**：首次运行会自动创建记忆文件
4. **归档触发**：只有在第21轮对话时才会触发归档
5. **概括质量**：概括质量取决于LLM模型的能力

## 技术架构

```
┌─────────────────────────────────────┐
│         GUI Layer (Tkinter)         │
│  - Chat Interface                   │
│  - Timeline Visualization           │
│  - Debug Panels                     │
└────────────┬────────────────────────┘
             │
┌────────────▼────────────────────────┐
│       ChatAgent (Core Logic)        │
│  - Message Processing               │
│  - Memory Management                │
│  - LLM Integration                  │
└────────────┬────────────────────────┘
             │
    ┌────────┴────────┐
    ▼                 ▼
┌─────────┐    ┌──────────────────┐
│   LLM   │    │ LongTermMemory   │
│  (API)  │    │  Manager         │
└─────────┘    └──────┬───────────┘
                      │
              ┌───────┴────────┐
              ▼                ▼
      ┌──────────────┐  ┌──────────────┐
      │ Short Term   │  │ Long Term    │
      │ Memory (20轮)│  │ Memory (概括) │
      └──────────────┘  └──────────────┘
```

## 开发者信息

- **版本**：v2.0
- **开发时间**：2025年11月
- **技术栈**：Python 3.12+, Tkinter, LangChain, SiliconFlow API
- **许可证**：MIT

## 常见问题

### Q: 为什么没有生成长期记忆？
A: 长期记忆只在对话超过20轮时才会自动生成。请确保已经进行了至少21轮对话。

### Q: 为什么没有提取到知识？
A: 知识提取每5轮对话触发一次。如果对话中没有明确的用户信息或知识点，可能不会提取到内容。尝试分享一些个人信息、偏好或经历。

### Q: 如何修改归档轮数？
A: 在`.env`文件中修改`MAX_SHORT_TERM_ROUNDS`参数（默认20）。

### Q: 如何修改知识提取频率？
A: 知识提取频率默认为5轮，可以在`long_term_memory.py`中修改`knowledge_extraction_interval`参数。

### Q: 时间线不显示？
A: 确保窗口大小足够大，或点击"更新主题时间线"按钮刷新。

### Q: 知识提取的内容不准确？
A: 知识提取质量取决于LLM模型的理解能力。可以尝试：
   1. 使用更强大的模型
   2. 在对话中更明确地表达信息
   3. 提供更多上下文

### Q: 如何手动删除某条知识？
A: 目前GUI不支持删除功能，可以直接编辑`knowledge_base.json`文件。未来版本会添加删除功能。

### Q: API调用失败？
A: 检查API密钥是否正确，网络连接是否正常，API额度是否充足。

## 更新日志

### v3.0 (2025-11-14) - 知识库版
- ✨ 新增知识库系统
- ✨ 自动知识提取功能（每5轮）
- ✨ 知识分类和标签系统
- ✨ 知识库搜索和筛选功能
- ✨ 知识库可视化面板
- 🎨 优化GUI布局，输入框固定底部
- 🎨 添加知识提取提示消息
- 📝 完善三层记忆架构文档

### v2.0 (2025-11-14) - 增强版
- ✨ 新增分层记忆系统（短期+长期）
- ✨ 新增主题时间线可视化
- ✨ 新增自动概括生成功能
- ✨ 新增UUID标识系统
- 🎨 优化GUI界面布局
- 📝 完善中文注释

### v1.0
- 基础对话功能
- 角色扮演
- 简单记忆系统
- 基础GUI界面

## 贡献

欢迎提交Issue和Pull Request！

## 联系方式

如有问题，请通过GitHub Issue联系。

