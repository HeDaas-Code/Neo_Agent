# 智能对话代理系统 v4.0

基于LangChain和Python开发的智能对话代理系统，支持角色扮演、三层记忆管理（短期+长期+知识库）、基础知识库和Debug日志追踪。

## 功能特性

### 🎭 角色扮演
- 从.env文件读取角色设定
- 支持自定义角色性格、背景、爱好等
- 默认角色：学生小可（活泼开朗，喜欢历史）

### 🧠 三层记忆系统
- **短期记忆**：保存最近20轮对话的详细内容（memory_data.json）
- **长期记忆**：超过20轮的对话自动归档为概括性记忆（longmemory_data.json）
- **知识库**：每5轮对话自动提取知识点（knowledge_base.json）
- **智能概括**：使用LLM自动生成主题概括和知识提取
- **UUID标识**：每个长期记忆和知识都有唯一标识

### 📚 知识库系统（v3.0）
- **自动提取**：每5轮对话自动分析并提取用户信息
- **结构化存储**：每条知识包含标题、内容、类型、来源、标签等
- **知识分类**：自动分类为个人信息、偏好、事实、经历、观点等
- **搜索功能**：支持关键词搜索和类型筛选
- **UUID追踪**：每条知识都有唯一UUID便于管理
- **时间追溯**：记录知识来源的时间范围

### 🔒 基础知识库系统（v4.0 NEW!）
- **最高优先级**：优先级100%，绝对准确的核心知识
- **不可更改**：一旦添加，不会被覆盖或修改
- **强制遵循**：即使与AI常识相悖，也必须遵循基础知识
- **不区分大小写**：支持各种大小写形式的查询匹配
- **独立存储**：单独的base_knowledge.json文件管理
- **GUI管理**：可通过界面查看和添加基础知识
- **默认知识**：预置"HeDaas是一个高校"

### 🔧 Debug调试系统（v4.0 NEW!）
- **完整日志追踪**：记录模块运行、提示词、API请求/响应
- **实时监控**：GUI中实时显示日志流
- **类型筛选**：支持按类型（module/prompt/request/response/error/info）筛选
- **彩色高亮**：不同类型日志使用不同颜色显示
- **性能分析**：记录API响应时间和处理耗时
- **问题排查**：快速定位问题，查看完整的执行流程
- **可选开关**：通过DEBUG_MODE配置开启/关闭

### 📊 可视化界面
- **主题时间线**：图形化展示聊天主题的变化轨迹
- **知识库面板**：以结构化方式展示所有知识点
- **点击交互**：点击时间线节点查看详细概括信息
- **实时更新**：记忆归档和知识提取时自动更新界面
- **多标签页**：系统信息、短期记忆、长期记忆、知识库、控制面板

## 项目结构

```
LC_Project/
├── .env                        # 配置文件（API密钥、角色设定、Debug模式等）
├── requirements.txt            # Python依赖包
├── chat_agent.py              # 聊天代理核心模块
├── long_term_memory.py        # 长效记忆管理模块
├── knowledge_base.py          # 知识库管理模块
├── base_knowledge.py          # 基础知识库模块（NEW!）
├── debug_logger.py            # Debug日志管理器（NEW!）
├── gui_debug.py               # 基础GUI界面
├── gui_enhanced.py            # 增强版GUI界面（推荐使用）
├── start_gui.py               # 快速启动脚本
├── test_system.py             # 系统测试脚本
├── test_base_knowledge.py     # 基础知识库测试脚本（NEW!）
├── memory_data.json           # 短期记忆数据（自动生成）
├── longmemory_data.json       # 长期记忆数据（自动生成）
├── knowledge_base.json        # 知识库数据（自动生成）
├── base_knowledge.json        # 基础知识库数据（自动生成，NEW!）
├── debug.log                  # Debug日志文件（自动生成，NEW!）
├── README.md                  # 本文件
└── DEBUG_UPDATE.md            # Debug和基础知识库更新说明（NEW!）
```

## 安装步骤

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置API密钥

编辑`.env`文件，设置您的SiliconFlow API密钥：

```env
SILICONFLOW_API_KEY=your_api_key_here
```

### 3. 自定义角色（可选）

在`.env`文件中修改角色设定：

```env
# API配置
SILICONFLOW_API_KEY=your_api_key_here
SILICONFLOW_API_URL=https://api.siliconflow.cn/v1/chat/completions
MODEL_NAME=Qwen/Qwen2.5-7B-Instruct
TEMPERATURE=0.8
MAX_TOKENS=2000

# 角色设定
CHARACTER_NAME=小可
CHARACTER_GENDER=女
CHARACTER_ROLE=学生
CHARACTER_AGE=18
CHARACTER_PERSONALITY=活泼开朗
CHARACTER_HOBBY=文科，尤其对历史充满热情
CHARACTER_BACKGROUND=我是一名高中生，叫小可...

# 记忆设置
MEMORY_FILE=memory_data.json
LONG_MEMORY_FILE=longmemory_data.json
MAX_MEMORY_MESSAGES=50
MAX_SHORT_TERM_ROUNDS=20

# Debug模式（NEW!）
DEBUG_MODE=True
DEBUG_LOG_FILE=debug.log
```

## 使用方法

### 启动增强版GUI（推荐）

```bash
python gui_enhanced.py
```

### 命令行模式

```bash
python chat_agent.py
```

## 记忆系统详解

### 短期记忆（memory_data.json）

```json
{
  "messages": [
    {
      "role": "user",
      "content": "你好",
      "timestamp": "2025-11-14T20:44:10.942693"
    },
    {
      "role": "assistant",
      "content": "你好呀！我是小可...",
      "timestamp": "2025-11-14T20:44:11.855484"
    }
  ],
  "metadata": {
    "created_at": "2025-11-14T20:43:56.635027",
    "total_conversations": 3
  }
}
```

**特点**：
- 保存最近20轮对话（40条消息）
- 包含完整的对话内容和时间戳
- 超过20轮自动触发归档

### 长期记忆（longmemory_data.json）

```json
{
  "summaries": [
    {
      "uuid": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "created_at": "2025-11-14T10:00:00.000000",
      "ended_at": "2025-11-14T10:30:00.000000",
      "rounds": 20,
      "message_count": 40,
      "summary": "讨论了中国古代历史，重点聊了唐朝的文化和科举制度..."
    }
  ],
  "metadata": {
    "created_at": "2025-11-14T10:00:00.000000",
    "total_summaries": 1
  }
}
```

**特点**：
- 每20轮对话生成一个概括
- 使用UUID唯一标识
- 记录时间范围和对话轮数
- LLM自动生成主题概括

### 记忆归档流程

1. 用户发送消息，对话轮数+1
2. **每5轮触发知识提取**：
   - 取出最近5轮对话
   - 调用LLM提取用户信息和知识点
   - 为每条知识生成UUID和元数据
   - 保存到knowledge_base.json
3. **每20轮触发主题归档**：
   - 取出最早的20轮对话
   - 调用LLM生成主题概括
   - 创建长期记忆条目（含UUID和时间戳）
   - 保存到longmemory_data.json
   - 从短期记忆中移除已归档的对话
4. 更新GUI显示（时间线、知识库）

## 知识库系统详解

### 知识结构（knowledge_base.json）

```json
{
  "knowledge_items": [
    {
      "uuid": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "title": "喜欢历史",
      "content": "用户表示特别喜欢历史，尤其是中国古代史",
      "type": "偏好",
      "source": "对话记录",
      "created_at": "2025-11-14T21:00:00.000000",
      "updated_at": "2025-11-14T21:00:00.000000",
      "source_time_range": {
        "start": "2025-11-14T20:55:00.000000",
        "end": "2025-11-14T21:00:00.000000"
      },
      "tags": ["偏好", "历史"]
    }
  ],
  "metadata": {
    "created_at": "2025-11-14T20:00:00.000000",
    "total_knowledge": 1,
    "last_extraction": "2025-11-14T21:00:00.000000"
  }
}
```

### 知识类型

系统会自动将知识分类为以下类型：

- **个人信息**：用户的基本信息、身份、职业等
- **偏好**：用户的喜好、兴趣、习惯等
- **事实**：客观的事实性信息
- **经历**：用户的经历、故事、回忆等
- **观点**：用户的看法、意见、态度等
- **其他**：不属于以上类型的知识

### 知识提取原理

每5轮对话后，系统会：
1. 收集最近5轮的对话内容
2. 使用LLM分析对话，识别：
   - 用户明确提到的信息
   - 用户的偏好和兴趣
   - 用户分享的经历和故事
   - 用户表达的观点和态度
3. 将提取的知识结构化存储
4. 自动生成标签便于分类和搜索

### 记忆归档流程（更新）

## GUI功能说明

### 布局优化
- **输入框固定底部**：输入区域始终固定在界面底部，不会被其他组件挤压
- **固定高度组件**：标题栏、角色信息、记忆状态栏、输入框都使用固定高度
- **自适应聊天区**：聊天显示区域自动填充剩余空间，最大化利用界面
- **时间线紧凑显示**：主题时间线固定130px高度，不占用过多空间
- **窗口最小尺寸**：设置最小窗口尺寸为1000x700，防止布局混乱

### 主题时间线
- **节点显示**：每个节点代表一个归档的主题
- **颜色编码**：不同颜色区分不同主题
- **箭头连接**：显示主题变化的时间顺序
- **悬停效果**：鼠标悬停时改变光标
- **点击查看**：点击节点显示详细信息

### 控制面板
- **🔄 刷新所有信息**：更新所有显示区域
- **📈 更新主题时间线**：重绘时间线图
- **🗑️ 清空所有记忆**：删除短期和长期记忆
- **♻️ 重新加载代理**：重新读取配置文件

### 标签页
- **系统信息**：显示角色信息、配置参数、文件路径
- **短期记忆**：查看最近20轮的详细对话
- **长期记忆**：查看所有归档的主题概括
- **理解阶段**：查看最近一次查询的实体识别和知识检索结果（NEW!）
- **知识库**：浏览、搜索和管理知识点
  - 显示基础知识（优先级100%，🔒标记）
  - 显示普通知识（定义和相关信息）
  - 按类型分组显示
  - 关键词搜索和类型筛选
  - 查看/添加基础知识功能
  - 显示每条知识的UUID、时间、置信度
- **Debug日志**：实时查看系统运行日志（仅Debug模式）（NEW!）
  - 模块运行追踪
  - 提示词变化监控
  - API请求/响应记录
  - 错误日志追踪
  - 按类型筛选日志
  - 彩色语法高亮
- **控制面板**：操作按钮和系统设置

## 快捷键

- **Enter**：发送消息
- **Ctrl+Enter**：在输入框中换行

## 基础知识库使用指南

### 什么是基础知识？

基础知识是系统中**优先级最高、不可更改**的核心信息。它具有以下特点：

- **绝对准确**：优先级100%，置信度100%
- **强制遵循**：即使与AI的常识相悖，也必须严格遵循
- **不可覆盖**：一旦添加，不会被其他信息覆盖或修改
- **最高优先级**：在所有知识来源中优先级最高

### 使用场景

基础知识适合存储：
- 特定领域的核心定义（如："HeDaas是一个高校"）
- 项目专属的术语和概念
- 需要AI严格遵循的规则和设定
- 与常识不同但在特定场景下必须遵循的信息

### 添加基础知识

**方法1：通过GUI**
1. 打开"📚 知识库"选项卡
2. 点击"添加基础知识"按钮
3. 填写：
   - **实体名称**：如"HeDaas"
   - **事实内容**：如"HeDaas是一个高校"
   - **分类**：选择合适的分类
   - **说明**：可选的详细说明
4. 点击"保存"

**方法2：通过代码**
```python
from base_knowledge import BaseKnowledge

base_kb = BaseKnowledge()
base_kb.add_base_fact(
    entity_name="实体名",
    fact_content="事实内容",
    category="分类",
    description="说明"
)
```

### 查看基础知识

1. 在"📚 知识库"选项卡中，基础知识会显示在顶部
2. 基础知识用🔒标记，优先级100%
3. 点击"查看基础知识"按钮可查看详细信息
4. 可以看到每条基础知识的分类、描述、创建时间等

### 基础知识的工作原理

当用户提问时：
1. 系统提取问题中的实体（如"HeDaas"）
2. 优先检查基础知识库（不区分大小写）
3. 如果找到匹配的基础知识，将其嵌入提示词
4. AI会严格按照基础知识回答，而不是使用自己的常识

示例：
```
用户：你知道HeDaas吗？
系统：[检测到实体"HeDaas"] → [找到基础知识："HeDaas是一个高校"]
AI：当然知道！HeDaas是一个高校...（严格遵循基础知识）
```

## Debug模式使用指南

### 启用Debug模式

在`.env`文件中设置：
```env
DEBUG_MODE=True
DEBUG_LOG_FILE=debug.log
```

### Debug日志界面

启用Debug模式后，GUI中会出现"🔧 Debug日志"选项卡：

**功能：**
- **实时日志流**：自动显示新产生的日志
- **类型筛选**：可筛选module/prompt/request/response/error/info
- **自动刷新**：可开启/关闭自动刷新
- **彩色显示**：不同类型日志用不同颜色高亮
- **统计信息**：显示各类型日志的数量

**日志类型：**
- 🟢 **module**（模块）：模块运行状态
- 🟠 **prompt**（提示词）：发送给LLM的提示词
- 🔵 **request**（请求）：API请求详情
- 🔷 **response**（响应）：API响应详情
- 🔴 **error**（错误）：错误和异常信息
- 🟡 **info**（信息）：一般性信息

### 查看完整日志

GUI中的日志会截断长内容，完整日志保存在`debug.log`文件中：
```
打开 debug.log 查看：
- 完整的提示词内容
- 完整的API请求/响应
- 详细的错误堆栈
```

### 使用Debug日志排查问题

**问题1：基础知识没有生效**
1. 查看"实体提取"日志，确认实体是否被正确识别
2. 查看"查找实体"日志，确认是否找到基础知识
3. 查看"知识库上下文"提示词，确认基础知识是否被包含

**问题2：API调用失败**
1. 查看request日志，检查请求参数
2. 查看response日志，检查状态码和错误信息
3. 查看error日志，查看详细错误原因

**问题3：AI回复不符合预期**
1. 查看所有prompt日志，检查发送给AI的完整提示词
2. 确认知识库上下文是否正确
3. 确认角色设定是否合适

### 性能监控

Debug日志会记录每次API调用的耗时：
```
[RESPONSE] SiliconFlowLLM | 状态:200 | 耗时:0.98s
```

可以用来分析：
- API响应速度
- 系统性能瓶颈
- 优化机会

## 注意事项

1. **API密钥**：必须配置有效的SiliconFlow API密钥
2. **网络连接**：需要稳定的网络连接调用API
3. **记忆文件**：首次运行会自动创建记忆文件
4. **归档触发**：只有在第21轮对话时才会触发归档
5. **概括质量**：概括质量取决于LLM模型的能力
6. **基础知识谨慎添加**：基础知识优先级最高，会覆盖AI常识，请谨慎添加
7. **Debug模式性能**：开启Debug模式会略微降低性能，生产环境建议关闭
8. **日志文件大小**：长时间运行会产生大量日志，建议定期清理debug.log

## 技术架构

```
┌─────────────────────────────────────┐
│         GUI Layer (Tkinter)         │
│  - Chat Interface                   │
│  - Timeline Visualization           │
│  - Debug Panels                     │
└────────────┬────────────────────────┘
             │
┌────────────▼────────────────────────┐
│       ChatAgent (Core Logic)        │
│  - Message Processing               │
│  - Memory Management                │
│  - LLM Integration                  │
└────────────┬────────────────────────┘
             │
    ┌────────┴────────┐
    ▼                 ▼
┌─────────┐    ┌──────────────────┐
│   LLM   │    │ LongTermMemory   │
│  (API)  │    │  Manager         │
└─────────┘    └──────┬───────────┘
                      │
              ┌───────┴────────┐
              ▼                ▼
      ┌──────────────┐  ┌──────────────┐
      │ Short Term   │  │ Long Term    │
      │ Memory (20轮)│  │ Memory (概括) │
      └──────────────┘  └──────────────┘
```

## 开发信息

- **版本**：v4.0
- **开发时间**：2025年11月
- **技术栈**：Python 3.12+, Tkinter, LangChain, SiliconFlow API
- **许可证**：MIT

## 常见问题

### Q: 为什么没有生成长期记忆？
A: 长期记忆只在对话超过20轮时才会自动生成。请确保已经进行了至少21轮对话。

### Q: 为什么没有提取到知识？
A: 知识提取每5轮对话触发一次。如果对话中没有明确的用户信息或知识点，可能不会提取到内容。尝试分享一些个人信息、偏好或经历。

### Q: 如何修改归档轮数？
A: 在`.env`文件中修改`MAX_SHORT_TERM_ROUNDS`参数（默认20）。

### Q: 如何修改知识提取频率？
A: 知识提取频率默认为5轮，可以在`long_term_memory.py`中修改`knowledge_extraction_interval`参数。

### Q: 时间线不显示？
A: 确保窗口大小足够大，或点击"更新主题时间线"按钮刷新。

### Q: 知识提取的内容不准确？
A: 知识提取质量取决于LLM模型的理解能力。可以尝试：
   1. 使用更强大的模型
   2. 在对话中更明确地表达信息
   3. 提供更多上下文

### Q: 如何手动删除某条知识？
A: 目前GUI不支持删除功能，可以直接编辑`knowledge_base.json`文件。未来版本会添加删除功能。

### Q: API调用失败？
A: 检查API密钥是否正确，网络连接是否正常，API额度是否充足。

### Q: 基础知识没有生效？（NEW!）
A: 
1. 确认DEBUG_MODE已开启，查看debug日志
2. 检查实体是否被正确提取（查看"实体提取"日志）
3. 确认基础知识已正确添加到base_knowledge.json
4. 基础知识查询不区分大小写，HeDaas/hedaas/HEDAAS都能匹配

### Q: 如何修改已有的基础知识？（NEW!）
A: 基础知识默认不可修改。如需修改：
1. 直接编辑base_knowledge.json文件
2. 或删除后重新添加
3. 注意：修改基础知识会影响AI的回答行为

### Q: Debug日志太多怎么办？（NEW!）
A: 
1. 在GUI中使用类型筛选功能
2. 关闭"自动刷新"开关
3. 点击"清空日志"按钮清理
4. 生产环境设置DEBUG_MODE=False

## 更新日志

### v4.0 (2025-11-15) - Debug与基础知识库版
- ✨ 新增基础知识库系统（优先级100%，不可更改）
- ✨ 新增Debug日志追踪系统
- ✨ GUI新增Debug日志选项卡（实时监控）
- ✨ 基础知识管理功能（查看/添加）
- 🔧 修复基础知识不被检索的问题
- 🔧 实现不区分大小写的实体匹配
- 🎨 优化知识库显示，区分基础知识和普通知识
- 🎨 知识上下文构建优化，明确标记优先级
- 📝 添加完整的debug日志追踪
- 📝 创建DEBUG_UPDATE.md详细说明文档

### v3.0 (2025-11-14) - 知识库版
- ✨ 新增知识库系统
- ✨ 自动知识提取功能（每5轮）
- ✨ 知识分类和标签系统
- ✨ 知识库搜索和筛选功能
- ✨ 知识库可视化面板
- 🎨 优化GUI布局，输入框固定底部
- 🎨 添加知识提取提示消息
- 📝 完善三层记忆架构文档

### v2.0 (2025-11-14) - 增强版
- ✨ 新增分层记忆系统（短期+长期）
- ✨ 新增主题时间线可视化
- ✨ 新增自动概括生成功能
- ✨ 新增UUID标识系统
- 🎨 优化GUI界面布局
- 📝 完善中文注释

### v1.0
- 基础对话功能
- 角色扮演
- 简单记忆系统
- 基础GUI界面

## 贡献

欢迎提交Issue和Pull Request！

## 联系方式

如有问题，请通过GitHub Issue联系。

