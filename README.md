# 智能对话代理系统 v2.0

基于LangChain和Python开发的智能对话代理系统，支持角色扮演、分层记忆管理和可视化调试。

## 功能特性

### 🎭 角色扮演
- 从.env文件读取角色设定
- 支持自定义角色性格、背景、爱好等
- 默认角色：学生小可（活泼开朗，喜欢历史）

### 🧠 分层记忆系统
- **短期记忆**：保存最近20轮对话的详细内容（memory_data.json）
- **长期记忆**：超过20轮的对话自动归档为概括性记忆（longmemory_data.json）
- **智能概括**：使用LLM自动生成每20轮对话的主题概括
- **UUID标识**：每个长期记忆都有唯一标识和时间戳

### 📊 可视化界面
- **主题时间线**：图形化展示聊天主题的变化轨迹
- **点击交互**：点击时间线节点查看详细概括信息
- **实时更新**：记忆归档时自动更新时间线
- **多标签页**：系统信息、短期记忆、长期记忆、控制面板

## 项目结构

```
LC_Project/
├── .env                        # 配置文件（API密钥、角色设定等）
├── requirements.txt            # Python依赖包
├── chat_agent.py              # 聊天代理核心模块
├── long_term_memory.py        # 长效记忆管理模块
├── gui_debug.py               # 基础GUI界面
├── gui_enhanced.py            # 增强版GUI界面（推荐使用）
├── memory_data.json           # 短期记忆数据（自动生成）
└── longmemory_data.json       # 长期记忆数据（自动生成）
```

## 安装步骤

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置API密钥

编辑`.env`文件，设置您的SiliconFlow API密钥：

```env
SILICONFLOW_API_KEY=your_api_key_here
```

### 3. 自定义角色（可选）

在`.env`文件中修改角色设定：

```env
CHARACTER_NAME=小可
CHARACTER_GENDER=女
CHARACTER_ROLE=学生
CHARACTER_AGE=18
CHARACTER_PERSONALITY=活泼开朗
CHARACTER_HOBBY=文科，尤其对历史充满热情
CHARACTER_BACKGROUND=我是一名高中生，叫小可...
```

## 使用方法

### 启动增强版GUI（推荐）

**方式1：使用启动脚本**
```bash
python start_gui.py
```

**方式2：直接启动**
```bash
python gui_enhanced.py
```

### 启动基础GUI

```bash
python gui_debug.py
```

### 命令行模式

```bash
python chat_agent.py
```

## 记忆系统详解

### 短期记忆（memory_data.json）

```json
{
  "messages": [
    {
      "role": "user",
      "content": "你好",
      "timestamp": "2025-11-14T20:44:10.942693"
    },
    {
      "role": "assistant",
      "content": "你好呀！我是小可...",
      "timestamp": "2025-11-14T20:44:11.855484"
    }
  ],
  "metadata": {
    "created_at": "2025-11-14T20:43:56.635027",
    "total_conversations": 3
  }
}
```

**特点**：
- 保存最近20轮对话（40条消息）
- 包含完整的对话内容和时间戳
- 超过20轮自动触发归档

### 长期记忆（longmemory_data.json）

```json
{
  "summaries": [
    {
      "uuid": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "created_at": "2025-11-14T10:00:00.000000",
      "ended_at": "2025-11-14T10:30:00.000000",
      "rounds": 20,
      "message_count": 40,
      "summary": "讨论了中国古代历史，重点聊了唐朝的文化和科举制度..."
    }
  ],
  "metadata": {
    "created_at": "2025-11-14T10:00:00.000000",
    "total_summaries": 1
  }
}
```

**特点**：
- 每20轮对话生成一个概括
- 使用UUID唯一标识
- 记录时间范围和对话轮数
- LLM自动生成主题概括

### 记忆归档流程

1. 用户发送消息，对话轮数+1
2. 系统检测短期记忆是否超过20轮
3. 如果超过，取出最早的20轮对话
4. 调用LLM生成主题概括
5. 创建长期记忆条目（含UUID和时间戳）
6. 保存到longmemory_data.json
7. 从短期记忆中移除已归档的对话
8. 更新GUI时间线显示

## GUI功能说明

### 布局优化
- **输入框固定底部**：输入区域始终固定在界面底部，不会被其他组件挤压
- **固定高度组件**：标题栏、角色信息、记忆状态栏、输入框都使用固定高度
- **自适应聊天区**：聊天显示区域自动填充剩余空间，最大化利用界面
- **时间线紧凑显示**：主题时间线固定130px高度，不占用过多空间
- **窗口最小尺寸**：设置最小窗口尺寸为1000x700，防止布局混乱

### 主题时间线
- **节点显示**：每个节点代表一个归档的主题
- **颜色编码**：不同颜色区分不同主题
- **箭头连接**：显示主题变化的时间顺序
- **悬停效果**：鼠标悬停时改变光标
- **点击查看**：点击节点显示详细信息

### 控制面板
- **🔄 刷新所有信息**：更新所有显示区域
- **📈 更新主题时间线**：重绘时间线图
- **🗑️ 清空所有记忆**：删除短期和长期记忆
- **♻️ 重新加载代理**：重新读取配置文件

### 标签页
- **系统信息**：显示角色信息和配置参数
- **短期记忆**：查看最近20轮的详细对话
- **长期记忆**：查看所有归档的主题概括
- **控制面板**：操作按钮和系统设置

## 快捷键

- **Enter**：发送消息
- **Ctrl+Enter**：在输入框中换行

## 注意事项

1. **API密钥**：必须配置有效的SiliconFlow API密钥
2. **网络连接**：需要稳定的网络连接调用API
3. **记忆文件**：首次运行会自动创建记忆文件
4. **归档触发**：只有在第21轮对话时才会触发归档
5. **概括质量**：概括质量取决于LLM模型的能力

## 技术架构

```
┌─────────────────────────────────────┐
│         GUI Layer (Tkinter)         │
│  - Chat Interface                   │
│  - Timeline Visualization           │
│  - Debug Panels                     │
└────────────┬────────────────────────┘
             │
┌────────────▼────────────────────────┐
│       ChatAgent (Core Logic)        │
│  - Message Processing               │
│  - Memory Management                │
│  - LLM Integration                  │
└────────────┬────────────────────────┘
             │
    ┌────────┴────────┐
    ▼                 ▼
┌─────────┐    ┌──────────────────┐
│   LLM   │    │ LongTermMemory   │
│  (API)  │    │  Manager         │
└─────────┘    └──────┬───────────┘
                      │
              ┌───────┴────────┐
              ▼                ▼
      ┌──────────────┐  ┌──────────────┐
      │ Short Term   │  │ Long Term    │
      │ Memory (20轮)│  │ Memory (概括) │
      └──────────────┘  └──────────────┘
```

## 开发者信息

- **版本**：v2.0
- **开发时间**：2025年11月
- **技术栈**：Python 3.12+, Tkinter, LangChain, SiliconFlow API
- **许可证**：MIT

## 常见问题

### Q: 为什么没有生成长期记忆？
A: 长期记忆只在对话超过20轮时才会自动生成。请确保已经进行了至少21轮对话。

### Q: 如何修改归档轮数？
A: 在`.env`文件中修改`MAX_SHORT_TERM_ROUNDS`参数（默认20）。

### Q: 时间线不显示？
A: 确保窗口大小足够大，或点击"更新主题时间线"按钮刷新。

### Q: API调用失败？
A: 检查API密钥是否正确，网络连接是否正常，API额度是否充足。

## 更新日志

### v2.0 (2025-11-14)
- ✨ 新增分层记忆系统（短期+长期）
- ✨ 新增主题时间线可视化
- ✨ 新增自动概括生成功能
- ✨ 新增UUID标识系统
- 🎨 优化GUI界面布局
- 📝 完善中文注释

### v1.0
- 基础对话功能
- 角色扮演
- 简单记忆系统
- 基础GUI界面

## 贡献

欢迎提交Issue和Pull Request！

## 联系方式

如有问题，请通过GitHub Issue联系。

