# 日程相似度检查功能说明

## 功能概述

根据用户需求，添加了智能的日程相似度检查功能。在创建新日程时，系统会自动检查当天是否已有相似的日程，并使用LLM判断应该保留哪一个。

## 核心特性

### 1. 自动相似度检测
- 创建日程时自动检查当天（同一日期）的所有已有日程
- 使用LLM智能判断新日程与已有日程是否相似
- 仅在同一天内进行检查，不同日期的日程互不影响

### 2. 智能保留策略
当检测到相似日程时，LLM会根据以下标准决定保留哪一个：
- 信息详细程度（标题和描述的完整性）
- 时间信息的明确程度
- 元数据的丰富程度

**保留规则：**
- 如果新日程更详细 → 删除旧日程，创建新日程
- 如果旧日程更详细 → 保留旧日程，不创建新日程

### 3. 明确区分不同日程
LLM会识别以下情况，将日程判定为"不相似"：
- 标题或描述明确表明是不同的活动
- 用户明确说明是与另一个日程不同的事情
- 主题、目的、参与者等关键要素有本质区别

## 使用方法

### 基本用法

```python
from schedule_manager import ScheduleManager, ScheduleType

manager = ScheduleManager()

# 创建日程时启用相似度检查
success, schedule, message = manager.create_schedule(
    title="团队会议",
    description="讨论项目进度",
    schedule_type=ScheduleType.APPOINTMENT,
    start_time="2024-01-15T10:00:00",
    end_time="2024-01-15T11:00:00",
    check_similarity=True  # 启用相似度检查
)
```

### 禁用相似度检查

```python
# 如果不需要检查相似度，可以禁用
success, schedule, message = manager.create_schedule(
    title="每日站会",
    description="团队同步",
    schedule_type=ScheduleType.RECURRING,
    start_time="2024-01-15T09:00:00",
    end_time="2024-01-15T09:15:00",
    check_similarity=False  # 禁用相似度检查
)
```

## 使用场景示例

### 场景1：用户重复提及相同日程

**已有日程：**
- 标题：团队会议
- 描述：讨论项目进度
- 时间：2024-01-15 10:00-11:00

**新日程：**
- 标题：项目进度讨论会议
- 描述：与团队成员讨论本周项目进度，包括开发、测试、部署各个环节的情况，制定下周计划
- 时间：2024-01-15 14:00-15:00

**结果：** LLM判定两个日程相似（都是关于项目进度的团队讨论），且新日程描述更详细，因此删除旧日程，创建新日程。

### 场景2：相似主题但不同活动

**已有日程：**
- 标题：健身
- 描述：去健身房锻炼
- 时间：2024-01-15 06:00-07:00

**新日程：**
- 标题：晨跑
- 描述：户外跑步锻炼
- 时间：2024-01-15 18:00-19:00

**结果：** 虽然都是运动相关，但LLM识别出这是两个不同的活动（健身房 vs 户外跑步），判定为不相似，两个日程都保留。

### 场景3：不同日期的相似日程

**已有日程：**
- 标题：周例会
- 时间：2024-01-15 10:00-11:00

**新日程：**
- 标题：周例会
- 时间：2024-01-22 10:00-11:00

**结果：** 虽然主题相同，但不在同一天，不触发相似度检查，两个日程都保留。

## 技术实现

### 新增文件

1. **schedule_similarity_checker.py**
   - `ScheduleSimilarityChecker` 类：使用LLM进行相似度判断
   - `get_schedules_on_same_day()` 函数：获取指定日期当天的所有日程

### 修改文件

2. **schedule_manager.py**
   - `create_schedule()` 方法：添加 `check_similarity` 参数
   - 在创建日程前调用相似度检查
   - 根据LLM判断结果决定是否删除旧日程或放弃创建

### LLM集成

使用SiliconFlow API进行相似度判断：
- 模型：Qwen/Qwen2.5-7B-Instruct
- Temperature: 0.3（较低温度以获得稳定输出）
- 返回JSON格式结果，包含：
  - `is_similar`: 是否相似
  - `reason`: 判断理由
  - `keep_schedule`: 应保留的日程（"new"/"existing"/"none"）

## 配置要求

### 环境变量

需要在 `.env` 文件中配置：

```bash
# SiliconFlow API配置
SILICONFLOW_API_KEY=your_api_key_here
SILICONFLOW_API_URL=https://api.siliconflow.cn/v1/chat/completions
MODEL_NAME=Qwen/Qwen2.5-7B-Instruct
```

### 依赖项

- `requests`: HTTP请求库
- `python-dotenv`: 环境变量管理（可选）

## 性能考虑

### API调用
- 每次相似度检查可能需要1-3秒（取决于LLM API响应时间）
- 如果API不可用或超时，会自动跳过相似度检查，直接创建日程

### 查询优化
- 只检查当天的日程，减少比较次数
- 使用数据库索引加速时间范围查询

### 错误处理
- API超时：30秒超时，失败后跳过检查
- 网络错误：自动降级，不影响日程创建
- JSON解析错误：记录日志，跳过检查

## 调试和日志

所有操作都会通过 `debug_logger` 记录：

```python
# 启用DEBUG模式查看详细日志
import os
os.environ['DEBUG_MODE'] = 'True'
os.environ['DEBUG_LOG_FILE'] = 'schedule_debug.log'
```

日志包含：
- 相似度检查的触发
- LLM请求和响应
- 判断结果和执行的操作
- 错误和异常信息

## 最佳实践

### 1. 日常使用建议
- 默认启用相似度检查（`check_similarity=True`）
- 对于批量导入或系统生成的日程，可以禁用检查以提高性能

### 2. 描述编写建议
- 提供详细的日程描述可以帮助LLM做出更准确的判断
- 在描述中包含关键信息：地点、参与者、议程等

### 3. 特殊情况处理
- 如果两个日程确实不同但LLM误判为相似，可以在描述中明确说明区别
- 对于周期性日程，建议使用 `ScheduleType.RECURRING` 类型

## 测试

运行测试脚本验证功能：

```bash
# 运行基本功能测试
python tests/test_schedule_similarity.py

# 运行演示脚本
python example_schedule_similarity.py
```

## 故障排除

### 问题1：相似度检查总是跳过
**原因：** LLM API不可用或配置错误
**解决：** 检查 `.env` 中的API配置，确认API密钥有效

### 问题2：判断结果不准确
**原因：** 日程描述信息不足
**解决：** 提供更详细的日程描述，包含更多上下文信息

### 问题3：性能较慢
**原因：** 每次创建日程都调用LLM API
**解决：** 对批量操作禁用相似度检查，或使用更快的模型

## 未来改进方向

1. **缓存优化**
   - 缓存LLM判断结果，避免重复请求
   - 实现本地相似度预判，减少API调用

2. **多日检查**
   - 支持检查相邻几天的日程相似度
   - 识别跨天的持续活动

3. **批量处理**
   - 支持一次性检查多个日程的相似度
   - 优化批量导入场景的性能

4. **用户反馈**
   - 允许用户确认或拒绝LLM的判断
   - 学习用户偏好，改进判断准确性

## 总结

日程相似度检查功能通过LLM智能判断，有效避免了重复日程的创建，同时确保保留信息更完整的版本。该功能设计灵活，可以根据需要启用或禁用，并具有良好的错误处理和降级机制，确保在各种情况下都不影响基本的日程管理功能。
