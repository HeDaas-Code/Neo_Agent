# 知识库系统 v2.0 升级说明

## 概述

知识库系统已升级到 v2.0，采用全新的**主体-定义-信息**三层绑定结构，支持置信度管理、冲突检测和自动清理功能。

## 核心特性

### 1. 主体绑定机制

每个知识点都绑定到一个**主体**（Entity），主体具有唯一的UUID标识。

```
主体（Entity）
├── UUID: 唯一标识符
├── 名称: 主体名称（如"张三"、"Python"、"Eloha"）
├── 定义: 主体的核心定义（唯一，高置信度）
└── 相关信息: 主体的其他属性、特征等（不限数量，中等置信度）
```

### 2. 定义管理

- **每个主体只能有一个定义**：定义描述了主体的本质属性（"是什么"）
- **冲突处理**：当提取到新定义时，旧定义会被自动替换
- **历史记录**：被替换的定义会保存在历史记录中，方便追溯
- **高置信度**：定义的默认置信度为 0.9-1.0

### 3. 相关信息管理

- **数量不限**：每个主体可以有多个相关信息
- **中等置信度**：相关信息的默认置信度为 0.7-0.8
- **过时标记**：当用户纠正错误时，旧信息会被标记为过时
- **自动清理**：系统会定期清理被标记为过时的信息

### 4. 置信度系统

知识按置信度排序，使用时优先采用高置信度的知识：

| 知识类型 | 置信度范围 | 图标 | 说明 |
|---------|----------|------|------|
| 定义 | 0.9 - 1.0 | ⭐ | 主体的核心定义，最高优先级 |
| 高置信度相关信息 | 0.7 - 0.9 | ✓ | 较为确定的信息 |
| 低置信度相关信息 | < 0.7 | ◦ | 不太确定的信息 |

### 5. 知识纠正机制

当用户明显纠正错误时：

1. LLM 检测到纠正行为（`is_correction: true`）
2. 系统标记相关的旧信息为过时（`obsolete: true`）
3. 添加新的正确信息
4. 定期清理过时信息（每50轮对话一次）

## 使用示例

### 示例1：主体定义的自动更新

```
用户: Eloha是一种红色物质
助手: [提取知识]
  - 主体: Eloha
  - 定义: 一种红色物质
  - 置信度: 0.9

用户: 不对，Eloha其实是神的名字
助手: [检测到纠正，更新定义]
  - 主体: Eloha
  - 新定义: 神的名字（在犹太教中）
  - 置信度: 0.95
  - 旧定义已移入历史记录
```

### 示例2：相关信息的累积

```
用户: Python是一种编程语言
助手: [提取知识]
  - 主体: Python
  - 定义: 一种编程语言
  - 置信度: 1.0

用户: Python语法简洁，适合初学者
助手: [添加相关信息]
  - 主体: Python
  - 相关信息1: 语法简洁
  - 相关信息2: 适合初学者
  - 置信度: 0.8

用户: Python在数据科学领域很流行
助手: [继续添加]
  - 主体: Python
  - 相关信息3: 在数据科学领域流行
  - 置信度: 0.8
```

## 数据结构

### 新格式（v2.0）

```json
{
  "entities": {
    "entity-uuid-1": {
      "uuid": "entity-uuid-1",
      "name": "Python",
      "normalized_name": "python",
      "definition": {
        "content": "一种高级编程语言",
        "type": "定义",
        "source": "对话记录",
        "confidence": 1.0,
        "created_at": "2025-11-14T10:00:00",
        "updated_at": "2025-11-14T10:00:00"
      },
      "related_info": [
        {
          "uuid": "info-uuid-1",
          "content": "语法简洁易学",
          "type": "特征",
          "confidence": 0.8,
          "obsolete": false,
          "created_at": "2025-11-14T10:05:00"
        },
        {
          "uuid": "info-uuid-2",
          "content": "广泛应用于数据科学",
          "type": "应用",
          "confidence": 0.85,
          "obsolete": false,
          "created_at": "2025-11-14T10:10:00"
        }
      ],
      "definition_history": [],
      "created_at": "2025-11-14T10:00:00",
      "updated_at": "2025-11-14T10:10:00"
    }
  },
  "entity_name_map": {
    "python": "entity-uuid-1"
  }
}
```

### 向后兼容

系统保留了旧格式的 `knowledge_items` 列表，确保与旧版本兼容。首次加载时会自动迁移旧数据。

## API 变化

### 新增方法

```python
# 查找或创建主体
entity_uuid = kb._find_or_create_entity("Python")

# 添加或更新定义
kb._add_or_update_entity_definition(
    entity_name="Python",
    definition="一种编程语言",
    confidence=0.95
)

# 添加相关信息
kb.add_related_info_to_entity(
    entity_name="Python",
    info_content="语法简洁",
    confidence=0.8
)

# 标记信息为过时
kb.mark_related_info_obsolete(
    entity_uuid="...",
    info_uuid="...",
    reason="用户提供了更正确的信息"
)

# 清理过时信息
cleaned_count = kb.cleanup_obsolete_info()
```

### 更新的方法

```python
# get_all_knowledge 现在返回结构化的主体-定义-信息列表
knowledge_list = kb.get_all_knowledge(sort_by_confidence=True)

# search_knowledge 支持按主体名称搜索
results = kb.search_knowledge(
    keyword="Python",
    entity_name="Python",  # 新增参数
    knowledge_type="定义"
)

# get_statistics 返回更详细的统计信息
stats = kb.get_statistics()
# {
#   'total_entities': 10,
#   'total_definitions': 10,
#   'total_related_info': 25,
#   'confidence_distribution': {...}
# }
```

## GUI 界面更新

### 知识库标签页

- **主体分组显示**：知识按主体分组展示
- **置信度标识**：不同置信度使用不同图标（⭐ ✓ ◦）
- **定义高亮**：主体定义单独显示在相关信息之前
- **搜索增强**：支持按主体名称搜索

### 示例显示

```
【主体: Python】

  ⭐ 定义 (置信度: 1.00)
     内容: 一种高级编程语言
     类型: 定义
     来源: 对话记录
     时间: 2025-11-14 10:00:00
     UUID: entity-uuid-1

  相关信息 (2条):
    • [特征] (置信度: 0.80)
       语法简洁易学
       时间: 2025-11-14 10:05:00 | UUID: info-uuid-1

    • [应用] (置信度: 0.85)
       广泛应用于数据科学
       时间: 2025-11-14 10:10:00 | UUID: info-uuid-2

--------------------------------------------------
```

## 自动维护机制

### 定期清理

系统每50轮对话自动执行一次清理：

1. 移除被标记为过时的相关信息
2. 精简定义历史记录（只保留最近3个）
3. 输出清理报告

### LLM 提示词优化

知识提取提示词已优化，能够：

- 准确识别对话中的主体
- 区分定义和相关信息
- 检测用户的纠正行为
- 评估信息的置信度

## 迁移指南

### 从 v1.0 迁移

系统会在首次加载时自动迁移旧数据：

1. 将旧的 `knowledge_items` 转换为主体结构
2. 根据知识类型判断是定义还是相关信息
3. 分配合适的置信度（迁移数据默认 0.7）
4. 保留原有的时间戳和UUID

### 注意事项

- 迁移后建议手动检查重要知识点
- 迁移的定义可能需要人工确认置信度
- 可以手动清理不需要的旧数据

## 性能优化

- 使用字典结构加快主体查找（O(1)）
- entity_name_map 提供快速名称查找
- 延迟清理机制减少I/O操作
- 只在必要时重建索引

## 最佳实践

1. **定义精确**：确保每个主体的定义准确、简洁
2. **及时纠正**：发现错误立即纠正，系统会自动处理
3. **定期检查**：通过GUI定期检查知识库质量
4. **置信度管理**：关注低置信度的知识，必要时手动验证
5. **避免重复**：LLM会自动去重，但建议检查相似主体

## 故障排查

### 问题1：定义被错误替换

**解决方案**：
- 检查 `definition_history` 查看历史定义
- 手动恢复正确的定义
- 调整 LLM 提取参数（temperature）

### 问题2：相关信息过多

**解决方案**：
- 手动调用 `cleanup_obsolete_info()`
- 标记不重要的信息为过时
- 调整知识提取间隔

### 问题3：置信度不准确

**解决方案**：
- 修改 LLM 提示词中的置信度评估标准
- 手动调整重要知识的置信度
- 增加人工审核机制

## 未来计划

- [ ] 支持知识关系图（主体之间的关联）
- [ ] 实现知识版本控制
- [ ] 添加知识来源追溯功能
- [ ] 支持多语言知识提取
- [ ] 实现知识推理能力
- [ ] 添加知识质量评分系统

## 更新日志

### v2.0 (2025-11-14)

- ✨ 新增主体-定义-信息三层结构
- ✨ 实现置信度管理系统
- ✨ 支持定义冲突自动处理
- ✨ 添加知识纠正机制
- ✨ 实现自动清理过时信息
- 🔄 优化LLM提取提示词
- 📝 更新GUI显示界面
- 🔧 支持旧版本数据自动迁移
- 📊 增强统计信息展示

---

**版本**: 2.0  
**更新时间**: 2025-11-14  
**开发者**: AI Assistant  

